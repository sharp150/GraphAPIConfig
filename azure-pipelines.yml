# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- main

pool:
  vmImage: windows-latest

steps:
- script: echo Execute Pipeline
  displayName: 'Execute Pipeline'
- task: CmdLine@2
  inputs:
    script: 'git clone https://github.com/wesley-trust/GraphAPI.git'
    workingDirectory: '$(System.ArtifactsDirectory)'
- task: CmdLine@2
  inputs:
    script: 'git clone https://github.com/wesley-trust/ToolKit.git'
    workingDirectory: '$(System.ArtifactsDirectory)'
- task: PowerShell@2
  inputs:
    targetType: 'inline'
    script: |
      . $(System.ArtifactsDirectory)\GraphAPI\Public\AzureAD\ConditionalAccess\Import-WTCAPolicy.ps1

            Import-WTCAPolicy `
              -TenantDomain $(TenantDomain) `
              -ClientID ${env:CLIENTID} `
              -ClientSecret ${env:CLIENTSECRET} `
              -Path $(Build.Repository.LocalPath)\AzureAD\ConditionalAccess `
              -UpdateExistingPolicies `
              -RemoveExistingPolicies `
              -Force
    pwsh: true
    workingDirectory: '$(System.ArtifactsDirectory)'

